name: gradido test CI

on:
  push:
    branches:
      - 2664-refactordevops-refine-test-ci-workflow

jobs:

  ##############################################################################
  # JOB: DOCKER BUILD TEST BACKEND #############################################
  ##############################################################################
  build_test_backend:
    name: Docker Build Test - Backend
    runs-on: ubuntu-latest
    #needs: [nothing]
    steps:
      ##########################################################################
      # CHECKOUT CODE ##########################################################
      ##########################################################################
      - name: Checkout code
        uses: actions/checkout@v3
      ##########################################################################
      # BACKEND ################################################################
      ##########################################################################
      - name: Backend | Build `test` image
        run: |
          docker build -f ./backend/Dockerfile --target test -t "gradido/backend:test" .
          docker save "gradido/backend:test" > /tmp/backend.tar
      - name: Upload Artifact
        uses: actions/upload-artifact@v3
        with:
          name: docker-backend-test
          path: /tmp/backend.tar

  ##############################################################################
  # JOB: DOCKER BUILD TEST DATABASE UP #########################################
  ##############################################################################
  build_test_database_up:
    name: Docker Build Test - Database up
    runs-on: ubuntu-latest
    #needs: [nothing]
    steps:
      ##########################################################################
      # CHECKOUT CODE ##########################################################
      ##########################################################################
      - name: Checkout code
        uses: actions/checkout@v3
      ##########################################################################
      # DATABASE UP ############################################################
      ##########################################################################
      - name: Database | Build `test_up` image
        run: |
          docker build --target test_up -t "gradido/database:test_up" database/
          docker save "gradido/database:test_up" > /tmp/database_up.tar
      - name: Upload Artifact
        uses: actions/upload-artifact@v3
        with:
          name: docker-database-test_up
          path: /tmp/database_up.tar

  ##############################################################################
  # JOB: DOCKER BUILD TEST MARIADB #############################################
  ##############################################################################
  build_test_mariadb:
    name: Docker Build Test - MariaDB
    runs-on: ubuntu-latest
    #needs: [nothing]
    steps:
      ##########################################################################
      # CHECKOUT CODE ##########################################################
      ##########################################################################
      - name: Checkout code
        uses: actions/checkout@v3
      ##########################################################################
      # BUILD MARIADB DOCKER IMAGE #############################################
      ##########################################################################
      - name: mariadb | Build `test` image
        run: |
          docker build --target mariadb_server -t "gradido/mariadb:test" -f ./mariadb/Dockerfile ./
          docker save "gradido/mariadb:test" > /tmp/mariadb.tar
      - name: Upload Artifact
        uses: actions/upload-artifact@v3
        with:
          name: docker-mariadb-test
          path: /tmp/mariadb.tar

  ##############################################################################
  # JOB: DOCKER BUILD TEST NGINX ###############################################
  ##############################################################################
  build_test_nginx:
    name: Docker Build Test - Nginx
    runs-on: ubuntu-latest
    steps:
      ##########################################################################
      # CHECKOUT CODE ##########################################################
      ##########################################################################
      - name: Checkout code
        uses: actions/checkout@v3
      ##########################################################################
      # BUILD NGINX DOCKER IMAGE ###############################################
      ##########################################################################
      - name: nginx | Build `test` image
        run: |
          docker build -t "gradido/nginx:test" nginx/
          docker save "gradido/nginx:test" > /tmp/nginx.tar
      - name: Upload Artifact
        uses: actions/upload-artifact@v3
        with:
          name: docker-nginx-test
          path: /tmp/nginx.tar

  ##############################################################################
  # JOB: LINT BACKEND ##########################################################
  ##############################################################################
  lint_backend:
    name: Lint - Backend
    runs-on: ubuntu-latest
    needs: [build_test_backend]
    steps:
      ##########################################################################
      # CHECKOUT CODE ##########################################################
      ##########################################################################
      - name: Checkout code
        uses: actions/checkout@v3
      ##########################################################################
      # DOWNLOAD DOCKER IMAGE ##################################################
      ##########################################################################
      - name: Download Docker Image (Backend)
        uses: actions/download-artifact@v3
        with:
          name: docker-backend-test
          path: /tmp
      - name: Load Docker Image
        run: docker load < /tmp/backend.tar
      ##########################################################################
      # LINT BACKEND ###########################################################
      ##########################################################################
      - name: backend | Lint
        run: docker run --rm gradido/backend:test yarn run lint

  ##############################################################################
  # JOB: LOCALES BACKEND #######################################################
  ##############################################################################
  locales_backend:
    name: Locales - Backend
    runs-on: ubuntu-latest
    needs: [build_test_backend]
    steps:
      ##########################################################################
      # CHECKOUT CODE ##########################################################
      ##########################################################################
      - name: Checkout code
        uses: actions/checkout@v3
      ##########################################################################
      # LOCALES BACKEND #####################################################
      ##########################################################################
      - name: Backend | Locales
        run: cd backend && yarn && yarn locales
  
  ##############################################################################
  # JOB: LINT DATABASE UP ######################################################
  ##############################################################################
  lint_database_up:
    name: Lint - Database Up
    runs-on: ubuntu-latest
    needs: [build_test_database_up]
    steps:
      ##########################################################################
      # CHECKOUT CODE ##########################################################
      ##########################################################################
      - name: Checkout code
        uses: actions/checkout@v3
      ##########################################################################
      # DOWNLOAD DOCKER IMAGE ##################################################
      ##########################################################################
      - name: Download Docker Image (Backend)
        uses: actions/download-artifact@v3
        with:
          name: docker-database-test_up
          path: /tmp
      - name: Load Docker Image
        run: docker load < /tmp/database_up.tar
      ##########################################################################
      # LINT DATABASE ##########################################################
      ##########################################################################
      - name: database | Lint
        run: docker run --rm gradido/database:test_up yarn run lint
  
  ##############################################################################
  # JOB: UNIT TEST BACKEND  ####################################################
  ##############################################################################
  unit_test_backend:
    name: Unit tests - Backend
    runs-on: ubuntu-latest
    needs: [build_test_mariadb]
    steps:
      ##########################################################################
      # CHECKOUT CODE ##########################################################
      ##########################################################################
      - name: Checkout code
        uses: actions/checkout@v3
      ##########################################################################
      # DOWNLOAD DOCKER IMAGES #################################################
      ##########################################################################
      - name: Download Docker Image (Mariadb)
        uses: actions/download-artifact@v3
        with:
          name: docker-mariadb-test
          path: /tmp
      - name: Load Docker Image
        run: docker load < /tmp/mariadb.tar
      ##########################################################################
      # UNIT TESTS BACKEND #####################################################
      ##########################################################################
      - name: backend | docker-compose mariadb
        run: docker-compose -f docker-compose.yml -f docker-compose.test.yml up --detach --no-deps mariadb
      - name: Sleep for 30 seconds
        run: sleep 30s
        shell: bash
      - name: backend | docker-compose database
        run: docker-compose -f docker-compose.yml -f docker-compose.test.yml up --detach --no-deps database
      - name: backend Unit tests | test
        run: cd database && yarn && yarn build && cd ../backend && yarn && yarn test
        # run: docker-compose -f docker-compose.yml -f docker-compose.test.yml exec -T backend yarn test
      ##########################################################################
      # COVERAGE CHECK BACKEND #################################################
      ##########################################################################
      - name: backend | Coverage check
        uses: webcraftmedia/coverage-check-action@master
        with:
          report_name: Coverage Backend
          type: lcov
          result_path: ./backend/coverage/lcov.info
          min_coverage: 80
          token: ${{ github.token }}

  ##########################################################################
  # DATABASE MIGRATION TEST UP + RESET #####################################
  ##########################################################################
  database_migration_test:
    name: Database Migration Test - Up + Reset
    runs-on: ubuntu-latest
    #needs: [nothing]
    steps:
      ##########################################################################
      # CHECKOUT CODE ##########################################################
      ##########################################################################
      - name: Checkout code
        uses: actions/checkout@v3
      ##########################################################################
      # DOCKER COMPOSE DATABASE UP + RESET #####################################
      ##########################################################################
      - name: database | docker-compose
        run: docker-compose -f docker-compose.yml up --detach mariadb
      - name: database | up
        run: docker-compose -f docker-compose.yml run -T database yarn up
      - name: database | reset
        run: docker-compose -f docker-compose.yml run -T database yarn reset

  ##############################################################################
  # JOB: END-TO-END TESTS  #####################################################
  ##############################################################################
  end-to-end-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: [build_test_mariadb, build_test_database_up, build_test_backend, build_test_nginx]
    steps:
      ##########################################################################
      # CHECKOUT CODE ##########################################################
      ##########################################################################
      - name: Checkout code
        uses: actions/checkout@v3
      ##########################################################################
      # DOWNLOAD DOCKER IMAGES #################################################
      ##########################################################################
      - name: Download Docker Image (Mariadb)
        uses: actions/download-artifact@v3
        with:
          name: docker-mariadb-test
          path: /tmp
      - name: Load Docker Image (Mariadb)
        run: docker load < /tmp/mariadb.tar
      - name: Download Docker Image (Database Up)
        uses: actions/download-artifact@v3
        with:
          name: docker-database-test_up
          path: /tmp
      - name: Load Docker Image (Database Up)
        run: docker load < /tmp/database_up.tar
      - name: Download Docker Image (Backend)
        uses: actions/download-artifact@v3
        with:
          name: docker-backend-test
          path: /tmp
      - name: Load Docker Image (Backend)
        run: docker load < /tmp/backend.tar
      - name: Download Docker Image (Nginx)
        uses: actions/download-artifact@v3
        with:
          name: docker-nginx-test
          path: /tmp
      - name: Load Docker Image (Nginx)
        run: docker load < /tmp/nginx.tar

      ##########################################################################
      # BOOT UP THE TEST SYSTEM ################################################
      ##########################################################################
      - name: Boot up test system | docker-compose mariadb
        run: docker-compose -f docker-compose.yml -f docker-compose.test.yml up --detach mariadb

      - name: Boot up test system | docker-compose database
        run: docker-compose -f docker-compose.yml -f docker-compose.test.yml up --detach --no-deps database

      - name: Boot up test system | docker-compose backend
        run: docker-compose -f docker-compose.yml -f docker-compose.test.yml up --detach --no-deps backend

      - name: Sleep for 10 seconds
        run: sleep 10s

      - name: Boot up test system | seed backend
        run: |
          sudo chown runner:docker -R *
          cd database
          yarn && yarn dev_reset
          cd ../backend
          yarn && yarn seed
          cd ..

      - name: Boot up test system | docker-compose frontends
        run: docker-compose -f docker-compose.yml -f docker-compose.test.yml up --detach --no-deps frontend admin nginx

      - name: Sleep for 15 seconds
        run: sleep 15s

      ##########################################################################
      # END-TO-END TESTS #######################################################
      ##########################################################################
      - name: End-to-end tests | run tests
        id: e2e-tests
        run: |
          cd e2e-tests/cypress/tests/
          yarn
          yarn run cypress run --spec cypress/e2e/User.Authentication.feature
      - name: End-to-end tests | if tests failed, upload screenshots
        if: steps.e2e-tests.outcome == 'failure'
        uses: actions/upload-artifact@v3
        with:
          name: cypress-screenshots
          path: /home/runner/work/gradido/gradido/e2e-tests/cypress/tests/cypress/screenshots/

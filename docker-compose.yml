# This file defines the production settings. It is overwritten by docker-compose.override.yml,
# which defines the development settings. The override.yml is loaded by default. Therefore it
# is required to explicitly define if you want an production build:
# > docker-compose -f docker-compose.yml up

services:
  ########################################################
  # Gradido ##############################################
  ########################################################
  gradido:
    image: gradido/gradido:local-production
    build:
      context: ./
      dockerfile: ./Dockerfile
      target: production
    depends_on:
      - mariadb
    networks:
      - internal-net
    ports:
      - ${BACKEND_PORT:-4000}:${BACKEND_PORT:-4000}
      - ${FEDERATION_PORT:-5010}:${FEDERATION_PORT:-5010}
      - ${FRONTEND_MODULE_PORT:-3000}:${FRONTEND_MODULE_PORT:-3000}
      - ${ADMIN_MODULE_PORT:-8080}:${ADMIN_MODULE_PORT:-8080}
    environment:
      # Envs used in Dockerfile
      # - DOCKER_WORKDIR="/app"
      # - PORT=4000
      - BUILD_DATE
      - BUILD_VERSION
      - BUILD_COMMIT
      - NODE_ENV=production
      - DB_HOST=mariadb
    volumes:
      - ./logs/backend:/logs/backend

  #########################################################
  ## MARIADB ##############################################
  #########################################################
  mariadb:
    image: mariadb:10.11.6
    environment:
      - MARIADB_ALLOW_EMPTY_ROOT_PASSWORD=1
      - MARIADB_USER=root
    networks:
      - internal-net
    ports:
      - 3306:3306
    volumes:
      - db_vol:/var/lib/mysql

  #########################################################
  ## NGINX ################################################
  #########################################################
  nginx:
    build:
      context: ./nginx/
    networks:
      - external-net
      - internal-net
    depends_on:
      - gradido
    ports:
      - 80:80
    volumes:
      - ./logs/nginx:/var/log/nginx

networks:
  external-net:
  internal-net:
    internal: true

volumes:
  db_vol:

